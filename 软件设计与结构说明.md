# 采集端软件架构设计说明
软件开发环境与构建套件: **Desktop Qt 6.9.0 MSVC2022 64bit**

项目结构工程主要由以下这四个主要部分组成
- [共享动态链接库](#共享库类)
- [设备插件类](#插件设备类)
- [服务端](#服务端)主要使用了Qt Core类,其次涉及的模块,比如串口和网络类也会有依赖
- [客户端](#客户端)Qt的常规 Widgets 等界面依赖,还有对应的网络模块

**其中设备开发相关的资料,通信接口等,在统一的doc目录或者项目的doc目录**

## Shared共享库类{#共享库类}

主要涉及是主程序和插件类的之间的交互,数据配置等需要共享的信息保存,方法触发等

## Plugin 插件设备类{#插件设备类}
使用统一的头文件 iPluginDevice.h 插件接口,然后使用插件管理类加载,调用方法主要有 **_配置加载,注册服务,状态机,任务执行类,会话类_**

- 串口类Serial:小车模块
- 主要通过串口协议控制,以及返回数据
- 扫描仪Scanner

    使用windows c++的api控制,新扫描使用http协议,详情请看doc目录下的资料接口文档和示例

- 相机Cameras

    主要通过SDK接口控制,详情请看doc目录下的资料接口文档和示例

## Server服务端程序{#服务端}

软件模块主要划分:
- 应用程序主要管理模块:配置管理,日志等,主要的启动加载初始化部分
- 设备控制采集模块:根据设备类型.通信方式划分,主要负责控制和数据采集保存
- 网络连接模块:主要用于界面的连接,交互,通信,文件下载,数据订阅推送等
- 用户交互模块:主要和界面显示的操作等

主要的功能设计有:
- 串口通信 iSerialPort.h
- 状态事件驱动(交互控制) StateEvent.h
- 设备SDK交互等 iPluginDevice.h

具体如下:

**_备注:在接口库的头文件中,有使用说明,和背景介绍_**

### 串口协议(设备控制 + 时间同步)
解析流程:
1. 读取数据,加入缓冲区
2. 根据包的起始字节,拆分数据块,循环处理数据块
3. 查找数据块的命名码,调用命令码的处理函数
```
MS201采用: [帧头][命令码][数据体][校验和][帧尾] 的结构。
MS301: [帧头][数据长度][命令码][数据体][校验和]
```
### 插件化设备管理（单例模式 + 插件架构）
+ 核心思想：为每种设备（扫描仪,相机）定义统一的C++抽象接口。
+ 实现：每个具体设备（如扫描仪,海康相机）编译为独立的动态库（.dll文件）。由一个单例的插件管理器在运行时根据配置加载所需的设备插件。
+ 益处：
    - 高内聚：每种设备的逻辑封装在独立的库中。
    - 低耦合：主程序仅依赖抽象接口，不依赖具体设备。
    - 易扩展：新增设备只需实现接口并编译成新插件，无需修改主程序代码。

### 状态机驱动应用流程（状态模式） 
+ 核心思想：将系统的运行阶段（如：初始化、标定、就绪、采集、错误）定义为明确的状态。
+ 实现：每个状态是一个独立的类，知道在什么事件下应该切换到哪个下一个状态。状态转换可以触发相应的操作（如初始化硬件、开始记录、停止记录）。
+ 益处：
    - 逻辑清晰：流程控制变得直观且结构化。
    - 健壮性：易于管理和处理异常状态。
    - 可维护性：添加新的工作流程或状态只需新增状态类，而无需修改大量条件判断语句。

**主要使用了模块化的实现,可大致按照设备类型,通信方式分类**

## TCC客户端{#客户端}
开发使用**Qt Creator**,然后主要根据设备插件类处理分类子控件的QWidget的,继承一个公共的抽象函数接口,主要有:
- 扫描仪
- 相机
- 小车

其操作界面主要分布在
- 设备管理
- 采集任务参数设置
- 采集界面实时监控

界面设计主要使用QSS为主,其次使用独立的控件,继承Button提升控件交互设计

### 主界面设计
+ MainWindow.h 主界面:负责呈现与交互
+ ChildWidget.h 实现设备类的管理界面的自定义的界面,后续的设备类会继承该类
+ MainControl.h 负责主界面的逻辑处理,业务层的交互

### 设备类界面 DeviceUI
主要搭载3个设备,小车,扫描仪,相机
+ 小车 TrolleyWidget.h
+ 扫描仪 ScannerWidget.h
+ 相机 CameraWidget.h

### 自定义界面 CustomUI
各种需要特定的界面,如
- ToolTip.h 提示弹窗
- WaitDialog.h 等待弹窗
- BatteryButton.h 电池控件等其他自定义控件
- **...**

